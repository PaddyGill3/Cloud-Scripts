#Custom Parameters
$Location = ''
$VMResourceGroup = ''
$StorageAccount = ''
$StorageAccountKey = ''
$Container = ''
$FileUrlLinux = ''


#Static Parameters
$FileNameWindows = 'WindowsCloudHealthAgentInstallTest.ps1'
$ExtensionName = 'CloudHealthExtension'
$Settings = '{"fileUris":["' + $fileUrlLinux + '"],"commandToExecute":"sh LinuxCloudHealthAgentInstallTest.sh"}';
$ProtectedSettings = '{"storageAccountName":"' + $StorageAccount + '","storageAccountKey":"' + $StorageAccountKey + '"}';

Write-Host $Settings

#Azure Login
Login-AzureRmAccount

#GatherVMs
$VMs = Get-AzureRmVM -ResourceGroup $VMResourceGroup
$vmOutput = @()
$VMs | ForEach-Object {
$tmpObj = New-Object -TypeName PSObject
$tmpObj | Add-Member -MemberType Noteproperty -Name "VM Name" -Value $_.Name
$tmpObj | Add-Member -MemberType Noteproperty -Name "OS type" -Value $_.StorageProfile.OsDisk.OsType
$vmOutput += $tmpObj
}
$vmoutput

#Filter Windows VMs
$WindowsVM = $vmoutput | where 'Os type' -eq "Windows" | Select "VM Name"

#Filter Linux VMs
$LinuxVM = $vmoutput | where 'Os type' -eq "Linux" | Select "VM Name"


#Add Custom Script Extension to Windows VMs
foreach ($VM in $WindowsVM."VM Name")
{
    Set-AzureRmVMCustomScriptExtension -Name $ExtensionName -ResourceGroupName $VMResourceGroup -VMName $VM -Location $Location -StorageAccountName $StorageAccount -ContainerName $Container -FileName $FileNameWindows 
}

#Add Custom Script Extension to Linux VMs
foreach ($VM in $LinuxVM."VM Name")
{
    Set-AzureRmVMExtension -Name $ExtensionName -ResourceGroupName $VMResourceGroup -VMName $VM -Location $Location -Publisher "Microsoft.OSTCExtensions" -ExtensionType  "CustomScriptForLinux" -TypeHandlerVersion "1.5" -Settingstring $Settings -ProtectedSettingString $ProtectedSettings
}
