{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "FailoverEnabled": {
            "type": "bool",
            "metadata": {
                "description": "Whether the Collectors are to be deployed in an avSet or Single VM."
            }
        },
        "vmName": {
            "type": "string",
            "minLength": 1,
            "maxLength": 15,
            "metadata": {
                "description": "Display Name for the Virtual Machine"
            }
        },
        "vmSize": {
            "type": "string",
            "allowedValues": [
                "Standard_D1_v2",
                "Standard_D2_v3",
                "Standard_D4_v3"
            ],
            "metadata": {
                "description": "VM Size/Type for the Virtual Machine"
            }
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Username for the Virtual Machine."
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for the Virtual Machine."
            }
        },
        "lmCollectorGroup": {
            "type": "string",
            "metadata": {
                "description": "Customers Collector Group Name."
            }
        },
        "lmAccessKey": {
            "type": "securestring",
            "metadata": {
                "description": "LogicMonitor Access Key."
            }
        },
        "lmSecretKey": {
            "type": "securestring",
            "metadata": {
                "description": "LogicMonitor Secret Key."
            }
        },
        "lmCollectorSize": {
            "type": "string",
            "allowedValues": [
                "small",
                "medium",
                "large"
            ],
            "defaultValue": "small",
            "metadata": {
                "description": "LogicMonitor Collector Size (Small 100 devices, Medium 500 devices, Large 750 devices)."
            }
        },
        "lmHost": {
            "defaultValue": "ans",
            "type": "string",
            "allowedValues": [
                "ans",
                "anstest"
            ],
            "metadata": {
                "description": "LogicMonitor Environment"
            }
        },
        "NewOrExistingvNet": {
            "type": "string",
            "allowedValues": [
                "New",
                "Existing"
            ],
            "metadata": {
                "description": "Virtual Machines are to be deployed in a new or existing vNet"
            }
        },
        "vNetResourceGroupName": {
            "type": "string",
            "metadata": {
                "description": "Name of the Resource Group for the existing Virtual Network."
            }
        },
        "vNetName": {
            "type": "string",
            "metadata": {
                "description": "Enter Existing Virtual Network Name"
            }
        },
        "vNetPrefix": {
            "type": "string",
            "metadata": {
                "description": "Enter vNet CIDR block if creating a new vNet"
            }
        },
        "subnetName": {
            "type": "string",
            "metadata": {
                "description": "Enter Existing Subnet Name"
            }
        },
        "subnetPrefix": {
            "type": "string",
            "metadata": {
                "description": "Enter Subnet CIDR block if creating a new vNet"
            }
        },
        "tagOwner": {
            "defaultValue": "Firstname Lastname",
            "type": "string",
            "metadata": {
                "description": "Enter owners tag value"
            }
        },
        "tagEnvironment": {
            "defaultValue": "Production",
            "type": "string",
            "metadata": {
                "description": "Enter environment tag value"
            }
        }
    },
    "variables": {
        "CollectorUri": "uri(deployment().properties.templateLink.uri,'LogicMonitor-Collector.json",
        "avSetUri": "uri(deployment().properties.templateLink.uri,'LogicMonitor-avSet.json",
        "vNetUri": "uri(deployment().properties.templateLink.uri,'LogicMonitor-Network.json"
    },
    "resources": [
        {
            "condition": "[not(parameters('FailoverEnabled'))]",
            "apiVersion": "2017-05-10",
            "name": "SingleCollector",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": "resourceId([parameters('vNetResourceGroupName')], Microsoft.Network/virtualNetworks, [parameters('vNetName')]",
            "copy": {
                "name": "singleCopy",
                "count": 1
            },
            "properties": {
                "parameters": {
                    "vmName": {
                        "type": "string",
                        "value": "[parameters('vmName')]"
                    },
                    "vmSize": {
                        "type": "string",
                        "value": "[parameters('vmSize')]"
                    },
                    "adminUsername": {
                        "type": "string",
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "type": "securestring",
                        "value": "[parameters('adminPassword')]"
                    },
                    "lmCollectorGroup": {
                        "type": "string",
                        "value": "[parameters('lmCollectorGroup')]"
                    },
                    "lmAccessKey": {
                        "type": "securestring",
                        "value": "[parameters('lmAccessKey')]"
                    },
                    "lmSecretKey": {
                        "type": "securestring",
                        "value": "[parameters('lmSecretKey')]"
                    },
                    "lmCollectorSize": {
                        "type": "string",
                        "value": "[parameters('lmCollectorSize')]"
                    },
                    "lmHost": {
                        "type": "string",
                        "value": "[parameters('lmHost')]"
                    },
                    "vNetResourceGroupName": {
                        "type": "string",
                        "value": "[parameters('vNetResourceGroupName')]"
                    },
                    "vNetName": {
                        "type": "string",
                        "value": "[parameters('vNetName')]"
                    },
                    "subnetName": {
                        "type": "string",
                        "value": "[parameters('subnetName')]"
                    },
                    "tagOwner": {
                        "type": "string",
                        "value": "[parameters('tagOwner')]"
                    },
                    "tagEnvironment": {
                        "type": "string",
                        "value": "[parameters('tagEnvironment')]"
                    }
                },
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('CollectorUri')]",
                    "contentVersion": "1.0.0.0"
                }
            }
        },
        {
            "condition": "[parameters('FailoverEnabled')]",
            "apiVersion": "2017-05-10",
            "name": "avSet",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "parameters": {
                    "vmName": {
                        "type": "string",
                        "value": "[parameters('vmName')]"
                    },
                    "tagOwner": {
                        "type": "string",
                        "value": "[parameters('tagOwner')]"
                    },
                    "tagEnvironment": {
                        "type": "string",
                        "value": "[parameters('tagEnvironment')]"
                    }
                }
            },
            "mode": "incremental",
            "templateLink": {
                "uri": "[variables('avSetUri')]",
                "contentVersion": "1.0.0.0"
            }
        },
        {
            "condition": "[parameters('FailoverEnabled')]",
            "apiVersion": "2017-05-10",
            "name": "FailoverCollectors",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": "resourceId([subscriptionId], [resourceGroupName], resourceType, resourceName1",
            "copy": {
                "name": "avSetCopy",
                "count": 2
            },
            "properties": {
                "parameters": {
                    "vmName": {
                        "type": "string",
                        "value": "[parameters('vmName')]"
                    },
                    "vmSize": {
                        "type": "string",
                        "value": "[parameters('vmSize')]"
                    },
                    "adminUsername": {
                        "type": "string",
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "type": "securestring",
                        "value": "[parameters('adminPassword')]"
                    },
                    "lmCollectorGroup": {
                        "type": "string",
                        "value": "[parameters('lmCollectorGroup')]"
                    },
                    "lmAccessKey": {
                        "type": "securestring",
                        "value": "[parameters('lmAccessKey')]"
                    },
                    "lmSecretKey": {
                        "type": "securestring",
                        "value": "[parameters('lmSecretKey')]"
                    },
                    "lmCollectorSize": {
                        "type": "string",
                        "value": "[parameters('lmCollectorSize')]"
                    },
                    "lmHost": {
                        "type": "string",
                        "value": "[parameters('lmHost')]"
                    },
                    "vNetResourceGroupName": {
                        "type": "string",
                        "value": "[parameters('vNetResourceGroupName')]"
                    },
                    "vNetName": {
                        "type": "string",
                        "value": "[parameters('vNetName')]"
                    },
                    "subnetName": {
                        "type": "string",
                        "value": "[parameters('subnetName')]"
                    },
                    "tagOwner": {
                        "type": "string",
                        "value": "[parameters('tagOwner')]"
                    },
                    "tagEnvironment": {
                        "type": "string",
                        "value": "[parameters('tagEnvironment')]"
                    }
                },
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('CollectorUri')]",
                    "contentVersion": "1.0.0.0"
                }
            }
        },
        {
            "condition": "[equals(parameters('NewOrExistingvNet'), 'New')]",
            "apiVersion": "2017-05-10",
            "name": "newvNet",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "parameters": {
                    "vmName": {
                        "type": "string",
                        "value": "[parameters('vmName')]"
                    },
                    "vNetName": {
                        "type": "string",
                        "value": "[parameters('vNetName')]"
                    },
                    "vNetPrefix": {
                        "type": "string",
                        "value": "[parameters('vNetPrefix')]"
                    },
                    "subnetName": {
                        "type": "string",
                        "value": "[parameters('subnetName')]"
                    },
                    "subnetPrefix": {
                        "type": "string",
                        "value": "[parameters('subnetPrefix')]"
                    },
                    "tagOwner": {
                        "type": "string",
                        "value": "[parameters('tagOwner')]"
                    },
                    "tagEnvironment": {
                        "type": "string",
                        "value": "[parameters('tagEnvironment')]"
                    }
                },
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('vNetUri')]",
                    "contentVersion": "1.0.0.0"
                }
            }
        }
    ],
    "outputs": {}
}